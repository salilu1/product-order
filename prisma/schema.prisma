generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model category {
  id          String          @id @default(uuid())
  name        String
  slug        String          @unique(map: "Category_slug_key")
  description String?
  status      category_status @default(ACTIVE)
  createdAt   DateTime        @default(now())
  product     product[]

  @@index([slug], map: "Category_slug_idx")
}

model order {
  id        String       @id @default(uuid())
  userId    String
  status    order_status @default(PENDING)
  createdAt DateTime     @default(now())
  user      user         @relation(fields: [userId], references: [id], map: "Order_userId_fkey")
  items     orderitem[] // rename from `orderitem` to `items` for readability
  payment   payment?
  @@index([status], map: "Order_status_idx")
  @@index([userId], map: "Order_userId_idx")
}

model orderitem {
  id        String  @id @default(uuid())
  orderId   String
  productId String
  quantity  Int
  price     Decimal @db.Decimal(10, 2)
  order     order   @relation(fields: [orderId], references: [id], map: "OrderItem_orderId_fkey")
  product   product @relation(fields: [productId], references: [id], map: "OrderItem_productId_fkey")

  @@index([orderId], map: "OrderItem_orderId_idx")
  @@index([productId], map: "OrderItem_productId_idx")
}

model product {
  id          String         @id @default(uuid())
  name        String
  description String
  price       Decimal        @db.Decimal(10, 2)
  stock       Int
  imageUrl    String
  status      product_status @default(ACTIVE)
  categoryId  String
  createdAt   DateTime       @default(now())
  orderitem   orderitem[]
  cartItem    cartItem[] // <-- add this
  category    category       @relation(fields: [categoryId], references: [id], map: "Product_categoryId_fkey")

  @@index([categoryId], map: "Product_categoryId_idx")
  @@index([status], map: "Product_status_idx")
}

model user {
  id        String    @id @default(uuid())
  email     String    @unique
  password  String
  role      user_role @default(USER)
  createdAt DateTime  @default(now())

  // BACK-RELATIONS
  order order[]
  payments  payment[]
  cart  cart? // <-- add this
}

model cart {
  id        String   @id @default(uuid())
  userId    String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // RELATION FIELDS
  user  user       @relation(fields: [userId], references: [id], map: "Cart_userId_fkey")
  items cartItem[]

  @@index([userId], map: "Cart_userId_idx")
}

model cartItem {
  id        String  @id @default(uuid())
  cartId    String
  productId String
  quantity  Int
  price     Decimal @db.Decimal(10, 2)
  cart      cart    @relation(fields: [cartId], references: [id])
  product   product @relation(fields: [productId], references: [id])

  @@unique([cartId, productId], name: "cartId_productId")
}
model payment {
  id            String         @id @default(uuid())
  orderId       String         @unique
  userId        String
  provider      payment_provider @default(CHAPA)

  // Chapa identifiers
  txRef         String         @unique
  chapaTxnId    String?        // returned on verify (optional)
  checkoutUrl   String?

  // amounts
  amount        Decimal        @db.Decimal(10, 2)
  currency      String         @default("ETB")

  // status tracking
  status        payment_status @default(PENDING)

  // raw response (optional but very useful)
  chapaRaw      Json?

  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  order         order          @relation(fields: [orderId], references: [id])
  user          user           @relation(fields: [userId], references: [id])

  @@index([userId], map: "Payment_userId_idx")
  @@index([status], map: "Payment_status_idx")
}

enum payment_status {
  PENDING
  SUCCESS
  FAILED
  CANCELLED
}

enum payment_provider {
  CHAPA
}


enum order_status {
  PENDING
  PROCESSING
  COMPLETED
  CANCELLED
}

enum user_role {
  ADMIN
  USER
}

enum category_status {
  ACTIVE
  INACTIVE
}

enum product_status {
  ACTIVE
  INACTIVE
}
